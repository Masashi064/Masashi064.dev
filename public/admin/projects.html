<!doctype html>
<meta charset="utf-8" />
<title>Projects.json Editor (EN/JA)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; }
  body { margin: 24px; max-width: 1080px; }
  h1 { margin: 0 0 8px; }
  .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin: 8px 0 16px; }
  button, input[type=file] { font: inherit; padding: 8px 12px; }
  .muted { opacity: .72; font-size: 12px; }
  .ok { color: #0a0; }
  .err { color: #a00; }
  .panel { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin: 16px 0; }
  .list { max-height: 320px; overflow: auto; border: 1px solid #eee; padding: 8px; border-radius: 8px; background: #fafafa; }
  .item { display: grid; grid-template-columns: 72px 1fr auto; gap: 10px; align-items: center; padding: 8px; border-bottom: 1px dashed #eee; }
  .item:last-child { border-bottom: none; }
  .thumb { width: 72px; height: 48px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; background: #fff; }
  .title { font-weight: 600; }
  .tags { font-size: 12px; opacity: .72; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .form-grid > .full { grid-column: 1 / -1; }
  label { display: block; font-size: 12px; opacity: .86; margin-bottom: 4px; }
  input[type=text], textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; font: inherit; }
  textarea { min-height: 88px; resize: vertical; }
  .actions { display: flex; gap: 8px; align-items: center; }
  .danger { background: #fee2e2; border-color: #fecaca; }
  textarea#ta { width: 100%; height: 36vh; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  dialog { border: none; border-radius: 12px; padding: 0; width: min(760px, 96vw); }
  .modal { padding: 16px; }
  .modal header { padding: 12px 16px; border-bottom: 1px solid #eee; font-weight: 600; }
  .modal main { padding: 16px; }
  .modal footer { padding: 12px 16px; border-top: 1px solid #eee; display: flex; gap: 8px; justify-content: flex-end; }
  pre { background: #0a0a0a; color: #e5e7eb; padding: 12px; border-radius: 8px; overflow: auto; }
  code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  /* tabs */
  .tabs { display: inline-flex; border: 1px solid #e5e7eb; border-radius: 10px; overflow: hidden; }
  .tabs button { border: 0; padding: 6px 10px; background: #fff; }
  .tabs button.active { background: #111; color: #fff; }
  .switch { display: inline-flex; align-items: center; gap: 8px; }
</style>

<h1>Projects.json Editor</h1>
<div class="row" style="justify-content: space-between;">
  <div class="row">
    <input type="file" accept="application/json" id="file" />
    <button id="validate">Validate</button>
    <button id="save">Save as projects.json</button>
    <span id="msg" class="muted"></span>
  </div>
  <div class="row">
    <span class="muted">プレビュー言語:</span>
    <div class="tabs" id="previewTabs">
      <button data-lang="en" class="active">EN</button>
      <button data-lang="ja">日本語</button>
    </div>
  </div>
</div>

<div class="panel">
  <div class="row" style="justify-content: space-between;">
    <div>現在の件数: <strong id="count">0</strong></div>
    <div class="actions">
      <button id="toggleNew">+ 新しいプロジェクトを追加</button>
    </div>
  </div>
  <div id="list" class="list"></div>
</div>

<!-- 新規作成 -->
<div id="newFormWrap" class="panel" style="display:none;">
  <h2 style="margin:0 0 12px;">新規プロジェクト</h2>

  <!-- 多言語タブ -->
  <div class="row">
    <div class="tabs" id="newTabs">
      <button data-lang="en" class="active">EN</button>
      <button data-lang="ja">日本語</button>
    </div>
    <label class="switch">
      <input type="checkbox" id="newTagsShared" checked />
      <span>tagsを英日共通で入力する</span>
    </label>
  </div>

  <div class="form-grid">
    <!-- 共通 -->
    <div>
      <label>image</label>
      <input type="text" id="n-image" placeholder="/assets/example.jpg" />
      <div class="muted">先頭「/」が無い場合は自動で補います</div>
    </div>
    <div>
      <label>demoUrl</label>
      <input type="text" id="n-demo" placeholder="https://example.vercel.app/" />
    </div>
    <div>
      <label>githubUrl</label>
      <input type="text" id="n-github" placeholder="https://github.com/you/repo" />
    </div>

    <!-- EN -->
    <div class="full lang-en">
      <label>title (EN)</label>
      <input type="text" id="n-title-en" placeholder="e.g. Profit Estimator" />
    </div>
    <div class="full lang-en">
      <label>description (EN)</label>
      <textarea id="n-desc-en" placeholder="Short description in English"></textarea>
    </div>
    <div class="full lang-en">
      <label>tags (comma, EN) ※共通にチェック時はここを使用</label>
      <input type="text" id="n-tags-en" placeholder="HTML, CSS, JavaScript" />
    </div>

    <!-- JA -->
    <div class="full lang-ja" style="display:none;">
      <label>タイトル（日本語）</label>
      <input type="text" id="n-title-ja" placeholder="例：利益・損出し計算機" />
    </div>
    <div class="full lang-ja" style="display:none;">
      <label>説明（日本語）</label>
      <textarea id="n-desc-ja" placeholder="日本語の紹介文"></textarea>
    </div>
    <div class="full lang-ja" style="display:none;">
      <label>タグ（カンマ区切り・日本語）※共通に未チェック時に使用</label>
      <input type="text" id="n-tags-ja" placeholder="HTML, CSS, JavaScript" />
    </div>
  </div>

  <div class="row">
    <button id="add">追加</button>
    <button id="cancelNew" class="danger">キャンセル</button>
  </div>
</div>

<h2 style="margin:16px 0 8px;">Raw JSON（配列）</h2>
<textarea id="ta">[]</textarea>

<!-- 編集モーダル -->
<dialog id="editModal">
  <div class="modal">
    <header id="editTitle">編集</header>
    <main id="editBody"></main>
    <footer>
      <button id="editConfirm">確定</button>
      <button id="editCancel">戻る</button>
    </footer>
  </div>
</dialog>

<script>
/* ========= 状態 ========= */
let data = [];     // projects[] array
let previewLang = 'en'; // EN / JA

/* ========= 要素 ========= */
const fileInput  = document.getElementById('file');
const ta         = document.getElementById('ta');
const listEl     = document.getElementById('list');
const cnt        = document.getElementById('count');
const msg        = document.getElementById('msg');

const validateBtn= document.getElementById('validate');
const saveBtn    = document.getElementById('save');

const toggleNewBtn = document.getElementById('toggleNew');
const newFormWrap  = document.getElementById('newFormWrap');
const newTabs      = document.getElementById('newTabs');
const previewTabs  = document.getElementById('previewTabs');
const newTagsShared= document.getElementById('newTagsShared');

const nImage   = document.getElementById('n-image');
const nDemo    = document.getElementById('n-demo');
const nGit     = document.getElementById('n-github');
const nTitleEn = document.getElementById('n-title-en');
const nDescEn  = document.getElementById('n-desc-en');
const nTagsEn  = document.getElementById('n-tags-en');
const nTitleJa = document.getElementById('n-title-ja');
const nDescJa  = document.getElementById('n-desc-ja');
const nTagsJa  = document.getElementById('n-tags-ja');

const addBtn      = document.getElementById('add');
const cancelNewBtn= document.getElementById('cancelNew');

const editModal   = document.getElementById('editModal');
const editTitle   = document.getElementById('editTitle');
const editBody    = document.getElementById('editBody');
const editConfirm = document.getElementById('editConfirm');
const editCancel  = document.getElementById('editCancel');

/* ========= イベント ========= */
// JSON読み込み
fileInput.onchange = async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const text = await f.text();
    const arr = parseJsonArray(text);
    data = arr;
    ta.value = pretty(data);
    renderList();
    setMsg('JSON を読み込みました', 'ok');
  }catch(err){
    setMsg('読み込み失敗: ' + err.message, 'err');
  }
};

// Validate
validateBtn.onclick = ()=>{
  try{
    parseAndValidate(ta.value);
    alert('OK! JSONは有効です。項目数: ' + data.length);
  }catch(err){
    alert('不正なJSONです: ' + err.message);
  }
};

// Save
saveBtn.onclick = ()=>{
  try{
    const checked = parseAndValidate(ta.value);
    download('projects.json', pretty(checked));
  }catch{
    alert('JSONの形式が正しくありません');
  }
};

// 新規フォーム開閉
toggleNewBtn.onclick = ()=>{
  newFormWrap.style.display = (newFormWrap.style.display === 'none' || newFormWrap.style.display === '') ? 'block' : 'none';
};

// 新規：言語タブ切替
newTabs.onclick = (e)=>{
  if(e.target.tagName !== 'BUTTON') return;
  const lang = e.target.getAttribute('data-lang');
  newTabs.querySelectorAll('button').forEach(b=> b.classList.toggle('active', b===e.target));
  document.querySelectorAll('.lang-en').forEach(el=> el.style.display = lang==='en' ? '' : 'none');
  document.querySelectorAll('.lang-ja').forEach(el=> el.style.display = lang==='ja' ? '' : 'none');
};

// 画面プレビュー言語切替
previewTabs.onclick = (e)=>{
  if(e.target.tagName !== 'BUTTON') return;
  previewLang = e.target.getAttribute('data-lang');
  previewTabs.querySelectorAll('button').forEach(b=> b.classList.toggle('active', b===e.target));
  renderList();
};

// 新規キャンセル
cancelNewBtn.onclick = ()=>{
  clearNewForm();
  newFormWrap.style.display = 'none';
};

// 新規追加 → 構築 → 検証 → push
addBtn.onclick = ()=>{
  try{
    const payload = buildNewPayload();
    // 次ID
    const nextId = getNextId(data);
    const obj = { id: nextId, ...payload };
    // 全体検証の前にローカル検証
    validateProject(obj, 0);
    data.push(obj);
    ta.value = pretty(data);
    renderList();
    clearNewForm();
    newFormWrap.style.display = 'none';
    setMsg(`追加しました（id: ${nextId}）`, 'ok');
  }catch(err){
    setMsg('入力エラー: ' + err.message, 'err');
  }
};

/* ========= 一覧 ========= */
function renderList(){
  cnt.textContent = data.length;
  if(!data.length){
    listEl.innerHTML = '<div class="muted">（まだありません）</div>';
    return;
  }
  const sorted = [...data].sort((a,b)=> (a.id ?? 0) - (b.id ?? 0));
  listEl.innerHTML = sorted.map(p => itemRow(p)).join('');
  listEl.querySelectorAll('img.thumb').forEach(img=>{
    img.onerror = () => { img.src = '/assets/placeholder.jpg'; };
  });
  listEl.querySelectorAll('[data-edit]').forEach(btn=>{
    btn.onclick = ()=>{
      const id = Number(btn.getAttribute('data-edit'));
      const idx = data.findIndex(x => x.id === id);
      if(idx >= 0) openEdit(idx);
    };
  });
}

function itemRow(p){
  const title = pickLocStr(p.title, previewLang) || '';
  const tags = toPreviewTags(p.tags, previewLang).join(', ');
  const img = esc(p.image || '');
  return `
    <div class="item">
      <img class="thumb" src="${img || '/assets/placeholder.jpg'}" alt="">
      <div>
        <div class="title">#${p.id} — ${esc(title)}</div>
        <div class="tags">${esc(tags)}</div>
        <div class="muted">
          <a href="${escAttr(p.demoUrl || '#')}" target="_blank" rel="noreferrer">demo</a> ·
          <a href="${escAttr(p.githubUrl || '#')}" target="_blank" rel="noreferrer">github</a>
        </div>
      </div>
      <div class="actions">
        <button data-edit="${p.id}">編集</button>
      </div>
    </div>
  `;
}

/* ========= 編集 ========= */
function openEdit(index){
  const p = data[index];
  editTitle.textContent = `編集：#${p.id}`;

  // 既存値の正規化
  const titleEn = (p.title?.en ?? '');
  const titleJa = (p.title?.ja ?? '');
  const descEn  = (p.description?.en ?? '');
  const descJa  = (p.description?.ja ?? '');
  const tagsIsShared = Array.isArray(p.tags);
  const tagsEn = tagsIsShared ? (p.tags || []) : (p.tags?.en ?? []);
  const tagsJa = tagsIsShared ? (p.tags || []) : (p.tags?.ja ?? []);

  editBody.innerHTML = `
    <div class="row" style="justify-content: space-between;">
      <div class="tabs" id="editTabs">
        <button data-lang="en" class="active">EN</button>
        <button data-lang="ja">日本語</button>
      </div>
      <label class="switch">
        <input type="checkbox" id="e-tags-shared" ${tagsIsShared ? 'checked' : ''}/>
        <span>tagsを英日共通で入力する</span>
      </label>
    </div>

    <div class="form-grid">
      <div>
        <label>image</label>
        <input type="text" id="e-image" value="${escAttr(p.image||'')}" />
        <div class="muted">先頭「/」が無い場合は自動で補います</div>
      </div>
      <div>
        <label>demoUrl</label>
        <input type="text" id="e-demo" value="${escAttr(p.demoUrl||'')}" />
      </div>
      <div>
        <label>githubUrl</label>
        <input type="text" id="e-github" value="${escAttr(p.githubUrl||'')}" />
      </div>

      <div class="full e-lang-en">
        <label>title (EN)</label>
        <input type="text" id="e-title-en" value="${escAttr(titleEn)}" />
      </div>
      <div class="full e-lang-en">
        <label>description (EN)</label>
        <textarea id="e-desc-en">${esc(descEn)}</textarea>
      </div>
      <div class="full e-lang-en">
        <label>tags (comma, EN) ※共通ONのときはこちら使用</label>
        <input type="text" id="e-tags-en" value="${escAttr(tagsEn.join(', '))}" />
      </div>

      <div class="full e-lang-ja" style="display:none;">
        <label>タイトル（日本語）</label>
        <input type="text" id="e-title-ja" value="${escAttr(titleJa)}" />
      </div>
      <div class="full e-lang-ja" style="display:none;">
        <label>説明（日本語）</label>
        <textarea id="e-desc-ja">${esc(descJa)}</textarea>
      </div>
      <div class="full e-lang-ja" style="display:none;">
        <label>タグ（カンマ区切り・日本語）※共通OFFのとき使用</label>
        <input type="text" id="e-tags-ja" value="${escAttr(tagsJa.join(', '))}" />
      </div>
    </div>
  `;

  // タブ切替
  const editTabs = document.getElementById('editTabs');
  editTabs.onclick = (e)=>{
    if(e.target.tagName!=='BUTTON') return;
    const lang = e.target.getAttribute('data-lang');
    editTabs.querySelectorAll('button').forEach(b=> b.classList.toggle('active', b===e.target));
    document.querySelectorAll('.e-lang-en').forEach(el=> el.style.display = lang==='en' ? '' : 'none');
    document.querySelectorAll('.e-lang-ja').forEach(el=> el.style.display = lang==='ja' ? '' : 'none');
  };

  // 確定
  editConfirm.onclick = ()=>{
    try{
      const payload = buildEditPayload();
      const id = p.id;
      data[index] = { id, ...payload };
      ta.value = pretty(data);
      renderList();
      setMsg(`更新しました（id: ${id}）`, 'ok');
      editModal.close();
    }catch(err){
      alert('入力エラー: ' + err.message);
    }
  };

  // 戻る
  editCancel.onclick = ()=> editModal.close();

  editModal.showModal();
}

function buildEditPayload(){
  const image = normalizeImage(getVal('e-image'));
  const demoUrl = getVal('e-demo');
  const githubUrl = getVal('e-github');

  const titleEn = getVal('e-title-en');
  const descEn  = getVal('e-desc-en');
  const titleJa = getVal('e-title-ja');
  const descJa  = getVal('e-desc-ja');

  const shared = document.getElementById('e-tags-shared').checked;
  const tagsEn = toTags(getVal('e-tags-en'));
  const tagsJa = toTags(getVal('e-tags-ja'));

  const obj = {
    title: { en: titleEn, ...(titleJa ? { ja: titleJa } : {}) },
    description: { en: descEn, ...(descJa ? { ja: descJa } : {}) },
    image, demoUrl, githubUrl,
    tags: shared ? tagsEn : { en: tagsEn, ...(tagsJa.length ? { ja: tagsJa } : {}) }
  };
  // 検証
  validateProject({ id: 1, ...obj }, 0, true); // idは仮でOK（型検査用）
  return obj;
}

/* ========= 新規 ========= */
function buildNewPayload(){
  const image = normalizeImage(nImage.value.trim());
  const demoUrl = nDemo.value.trim();
  const githubUrl = nGit.value.trim();
  const titleEn = nTitleEn.value.trim();
  const descEn  = nDescEn.value.trim();
  const titleJa = nTitleJa.value.trim();
  const descJa  = nDescJa.value.trim();
  const shared  = newTagsShared.checked;
  const tagsEn  = toTags(nTagsEn.value.trim());
  const tagsJa  = toTags(nTagsJa.value.trim());

  const obj = {
    title: { en: titleEn, ...(titleJa ? { ja: titleJa } : {}) },
    description: { en: descEn, ...(descJa ? { ja: descJa } : {}) },
    image, demoUrl, githubUrl,
    tags: shared ? tagsEn : { en: tagsEn, ...(tagsJa.length ? { ja: tagsJa } : {}) }
  };
  // 検証
  validateProject({ id: 1, ...obj }, 0, true);
  return obj;
}

function clearNewForm(){
  [nImage, nDemo, nGit, nTitleEn, nDescEn, nTagsEn, nTitleJa, nDescJa, nTagsJa].forEach(el => el.value = '');
  newTagsShared.checked = true;
  // ENタブに戻す
  newTabs.querySelectorAll('button').forEach(b=> b.classList.toggle('active', b.getAttribute('data-lang')==='en'));
  document.querySelectorAll('.lang-en').forEach(el=> el.style.display = '');
  document.querySelectorAll('.lang-ja').forEach(el=> el.style.display = 'none');
}

/* ========= 検証/解析 ========= */
function parseJsonArray(text){
  const obj = JSON.parse(text || '[]');
  if(Array.isArray(obj)) return obj;
  if(Array.isArray(obj.projects)) return obj.projects; // {projects: []} で来てもOK
  throw new Error('JSONは配列、または { "projects": [] } 形式である必要があります');
}

function parseAndValidate(text){
  const arr = parseJsonArray(text);
  // 個別検証
  arr.forEach((p,i)=> validateProject(p, i));
  // id重複
  const seen = new Set();
  for(const p of arr){
    if(seen.has(p.id)) throw new Error(`id 重複: ${p.id}`);
    seen.add(p.id);
  }
  // OKなら data に反映
  data = arr;
  return arr;
}

function validateProject(p, idx, skipId){
  if(!skipId){
    if(typeof p.id !== 'number') throw new Error(`${idx}: id は number`);
  }
  // title/description: 多言語オブジェクト必須（enは最低限必要）
  mustObjWithEn(p.title, `${idx}: title`);
  mustObjWithEn(p.description, `${idx}: description`);

  mustStr(p.image, `${idx}: image`);
  mustStr(p.demoUrl, `${idx}: demoUrl`);
  mustStr(p.githubUrl, `${idx}: githubUrl`);
  if(p.demoUrl && !isHttp(p.demoUrl)) throw new Error(`${idx}: demoUrl は http(s)://`);
  if(p.githubUrl && !isHttp(p.githubUrl)) throw new Error(`${idx}: githubUrl は http(s)://`);

  // tags: string[] もしくは {en:string[], ja?:string[]}
  if(Array.isArray(p.tags)){
    if(!p.tags.every(x => typeof x === 'string')) throw new Error(`${idx}: tags は string[] が必要です`);
  }else if(typeof p.tags === 'object' && p.tags){
    if(!Array.isArray(p.tags.en) || !p.tags.en.every(x=>typeof x==='string')) throw new Error(`${idx}: tags.en は string[]`);
    if(p.tags.ja && !Array.isArray(p.tags.ja)) throw new Error(`${idx}: tags.ja は省略可だが配列なら string[]`);
  }else if(p.tags !== undefined){
    throw new Error(`${idx}: tags は配列 or {en:string[], ja?:string[]}`);
  }
}

/* ========= 小物 ========= */
function pickLocStr(obj, lang){
  if(!obj || typeof obj !== 'object') return '';
  return (lang==='ja' ? (obj.ja ?? obj.en ?? '') : (obj.en ?? obj.ja ?? ''));
}
function toPreviewTags(tags, lang){
  if(!tags) return [];
  if(Array.isArray(tags)) return tags;
  return (lang==='ja' ? (tags.ja ?? tags.en ?? []) : (tags.en ?? tags.ja ?? []));
}
function toTags(s){ return (s||'').split(',').map(x=>x.trim()).filter(Boolean); }
function normalizeImage(p){ return p ? (p.startsWith('/') ? p : '/'+p) : p; }
function mustStr(v, name){ if(typeof v !== 'string' || !v) throw new Error(`${name} は必須です`); }
function mustObjWithEn(v, name){
  if(!v || typeof v !== 'object') throw new Error(`${name} は {en:string, ja?:string} 形式`);
  if(typeof v.en !== 'string' || !v.en) throw new Error(`${name}.en は必須`);
}
function isHttp(u){ return /^https?:\/\//i.test(u); }
function getNextId(arr){
  const max = arr.reduce((m, it)=> typeof it.id === 'number' ? Math.max(m, it.id) : m, 0);
  return max + 1;
}
function pretty(x){ return JSON.stringify(x, null, 2); }
function esc(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
function escAttr(s){ return esc(s).replace(/"/g, '&quot;'); }
function getVal(id){ return document.getElementById(id)?.value?.trim() ?? ''; }
function download(name, content){
  const blob = new Blob([content], {type:'application/json'});
  const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: name });
  a.click(); URL.revokeObjectURL(a.href);
}
</script>
